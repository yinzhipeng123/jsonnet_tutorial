<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>jsonnet项目实战-kube-prometheus</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>jsonnet项目实战-kube-prometheus</h1><br/>学习了jsonnet 学习下jsonnet的项目<br /><br /><br />kube-prometheus的项目地址 <a href="https://github.com/prometheus-operator/kube-prometheus">https://github.com/prometheus-operator/kube-prometheus</a><br /><br />gojsontoyaml的项目地址 <a href="https://github.com/brancz/gojsontoyaml">https://github.com/brancz/gojsontoyaml</a><br /><br />kube-prometheus 把k8s集群的通用监控标准化，达到“开箱即用”的效果，是个很“贴心”的项目。它本来是Prometheus Operator的一部分，后来分离出来独立发布。<br />这个项目用jsonnet维护。 jsonnet是一个模板语言，用来生成json文件，大多用来维护配置。k8s的配置大家习惯用yaml保存， 所以生成的json又用了一个golang工具gojsontoyaml转了一下格式，保存在manifest/目录下。项目原生的配置文件也被提交到了repo，所以对于没有定制要求的使用者，直接用manifest/下的文件就够了。<br /><br />这里需要注意兼容性， 项目里维护了几个分支，对应k8s的不同版本，要根据实际情况选择，这点参见README.md。 比如我们运行1.16，选择分支release-0.4。<br />manifest/有个子目录manifest/setup/，保存的是namespace和CRD，需要先于其他文件创建，生效之后再创建manifest/中的其他内容。 把repo 克隆下来，执行下面命令：<br /><br /><div class="codebox"><div class="codebox"><span style="color:#ff9d00;font-weight:700">cd</span>&nbsp;kube-prometheus<br />kubectl&nbsp;create&nbsp;-f&nbsp;manifests<span style="color:#ff9d00;font-weight:700">/</span>setup<br /><span style="color:#ff9d00;font-weight:700">until</span>&nbsp;kubectl&nbsp;get&nbsp;servicemonitors&nbsp;--all-namespaces&nbsp;<span style="color:#ff9d00;font-weight:700">;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">do</span>&nbsp;<span style="color:#ff9d00;font-weight:700">date;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">sleep</span>&nbsp;1<span style="color:#ff9d00;font-weight:700">;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">echo</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;&quot;</span><span style="color:#ff9d00;font-weight:700">;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">done</span><br />kubectl&nbsp;create&nbsp;-f&nbsp;manifests<span style="color:#ff9d00;font-weight:700">/</span></div></div><br /><br />它会自动完成如下工作：**<br />• 一个新的表空间monitoring<br />• Prometheus Operator和相关的CRD<br />• 两节点的Prometheus服务<br />• 三节点的Alert Manager服务<br />• 每个节点上部署node-exporter<br />• 提供k8s相关指标的服务<br />• 单节点grafana和通用的dashboard<br />• 通用的监控告警规则<br />• 上述服务间的整合及传输加密<br /><br />运行成功后，monitoring这个namepace应该有下面资源：<br /><br /><div class="codebox"><div class="codebox"><span style="color:#0088ff;font-weight:400">#&nbsp;kubectl&nbsp;get&nbsp;pod&nbsp;-nmonitoring</span><br />NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READY&nbsp;&nbsp;&nbsp;STATUS&nbsp;&nbsp;&nbsp;&nbsp;RESTARTS&nbsp;&nbsp;&nbsp;AGE<br />alertmanager-main-0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;85d<br />alertmanager-main-1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;85d<br />alertmanager-main-2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;85d<br />grafana-8499b48c69-wlrq2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1<span style="color:#ff9d00;font-weight:700">/</span>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10d<br />kube-state-metrics-6f856648b9-gt9hq&nbsp;&nbsp;&nbsp;&nbsp;3<span style="color:#ff9d00;font-weight:700">/</span>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />node-exporter-2vhqr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />node-exporter-66hq7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />node-exporter-9xzzw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />node-exporter-bqjqs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />node-exporter-br4bd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />node-exporter-mc24r&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />node-exporter-vm7h2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<span style="color:#ff9d00;font-weight:700">/</span>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />prometheus-adapter-54d6dfd87b-k6dqg&nbsp;&nbsp;&nbsp;&nbsp;1<span style="color:#ff9d00;font-weight:700">/</span>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />prometheus-k8s-0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3<span style="color:#ff9d00;font-weight:700">/</span>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;85d<br />prometheus-k8s-1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3<span style="color:#ff9d00;font-weight:700">/</span>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;85d<br />prometheus-operator-76878f58ff-lpd56&nbsp;&nbsp;&nbsp;1<span style="color:#ff9d00;font-weight:700">/</span>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br /><br /><span style="color:#0088ff;font-weight:400">#&nbsp;kubectl&nbsp;get&nbsp;svc&nbsp;-nmonitoring</span><br />NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLUSTER-IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXTERNAL-IP&nbsp;&nbsp;&nbsp;PORT<span style="color:#ff9d00;font-weight:700">(</span>S<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AGE<br />alertmanager-main&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP&nbsp;&nbsp;&nbsp;172.25.245.53&nbsp;&nbsp;&nbsp;&nbsp;&lt;none&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9093<span style="color:#ff9d00;font-weight:700">/</span>TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />alertmanager-operated&nbsp;&nbsp;&nbsp;ClusterIP&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;none&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9093<span style="color:#ff9d00;font-weight:700">/</span>TCP,9094<span style="color:#ff9d00;font-weight:700">/</span>TCP,9094<span style="color:#ff9d00;font-weight:700">/</span>UDP&nbsp;&nbsp;&nbsp;109d<br />grafana&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP&nbsp;&nbsp;&nbsp;172.24.76.224&nbsp;&nbsp;&nbsp;&nbsp;&lt;none&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3000<span style="color:#ff9d00;font-weight:700">/</span>TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />kube-state-metrics&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;none&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8443<span style="color:#ff9d00;font-weight:700">/</span>TCP,9443<span style="color:#ff9d00;font-weight:700">/</span>TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />node-exporter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;none&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9100<span style="color:#ff9d00;font-weight:700">/</span>TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />prometheus-adapter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP&nbsp;&nbsp;&nbsp;172.17.98.210&nbsp;&nbsp;&nbsp;&nbsp;&lt;none&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;443<span style="color:#ff9d00;font-weight:700">/</span>TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />prometheus-k8s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP&nbsp;&nbsp;&nbsp;172.21.148.119&nbsp;&nbsp;&nbsp;&lt;none&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9090<span style="color:#ff9d00;font-weight:700">/</span>TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />prometheus-operated&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;none&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9090<span style="color:#ff9d00;font-weight:700">/</span>TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d<br />prometheus-operator&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;none&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8080<span style="color:#ff9d00;font-weight:700">/</span>TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;109d</div></div><br /><br /><br />组件web的访问分别对应几个service：<br />• Prometheus: prometheus-k8s.monitoring.svc:9090<br />• Alert Manager: alertmanager-main.monitoring.svc:9093<br />• Grafana: grafana.monitoring.svc:3000<br /><br />具体的访问方法要根据你集群的实际情况配置。<br />用默认用户admin/admin登录grafana，能看到一组默认的dashboard:<br /><a href=""><img src="images/814-1.png" alt="images/814-1.png" /></a><br /><br />默认的配置可能遇到几个问题：<br />• 所有用到的image都从源仓库获取。 如果集群用内部仓库，不能访问外网，拉取会失败。即使能对外访问，dockerhub和gcr这些国外镜像都不容易拉取。<br />• Prometheus的数据并没有持久化，实例重启后，历史数据会丢失。<br />• Alert Manager和grafana都是默认配置，告警没法自动发送到外部。<br /><br />除此以外，如果还想把集群中运行的所有服务都整合到统一的监控体系中，就需要基于kube-prometheus进行修改<br /><br /><br /><br /><h2>定制的原则</h2><br />kube-prometheus这个项目开发的其实是一个jsonnet的库，核心代码在jsonnet/kube-prometheus目录下， 其他文件大多是说明和例子。 通过jsonnet解释执行example.jsonnet这个入口，在manifests/目录下生成之前提到的配置文件。<br />这个项目用到了很多上游的jsonnet库，比如：<br />• 用来生成k8s原生组件库： https://github.com/ksonnet/ksonnet-lib<br />• 生成grafana的组件库：https://github.com/grafana/jsonnet-libs<br />• 一部分预置的grafana面板和告警规则： https://github.com/kubernetes-monitoring/kubernetes-mixin<br />• ...<br /><br />完整列表在jsonnet/kube-prometheus/jsonnetfile.json`。<br /><br />jsonnet是google开发的模板语言(data templating language)，可以定义和生成json。 jsonnet支持变量、函数、条件、运算、包管理、错误处理等，用来更方便的维护配置文件。 创造一个新的语言来解决工程问题<br /><br /><br /> jsonnet-builder是jsonnet的包管理工具,地址<a href="https://github.com/jsonnet-bundler/jsonnet-bundler">https://github.com/jsonnet-bundler/jsonnet-bundler</a><br /><br />安装jsonnet-builder 和gojsontoyaml，这里要安装jsonnet，参考之前的内容<br /><br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;~]#&nbsp;GO111MODULE=<span style="color:#3ad900;font-weight:400">&quot;on&quot;</span>&nbsp;go&nbsp;get&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>jsonnet-bundler<span style="color:#ff9d00;font-weight:700">/</span>jsonnet-bundler<span style="color:#ff9d00;font-weight:700">/</span>cmd<span style="color:#ff9d00;font-weight:700">/</span>jb<br />go<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;found&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>jsonnet-bundler<span style="color:#ff9d00;font-weight:700">/</span>jsonnet-bundler<span style="color:#ff9d00;font-weight:700">/</span>cmd<span style="color:#ff9d00;font-weight:700">/</span>jb&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>jsonnet-bundler<span style="color:#ff9d00;font-weight:700">/</span>jsonnet-bundler&nbsp;v0.4.0<br />go<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;downloading&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>fatih<span style="color:#ff9d00;font-weight:700">/</span>color&nbsp;v1.7.0<br />go<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;downloading&nbsp;gopkg.in<span style="color:#ff9d00;font-weight:700">/</span>alecthomas<span style="color:#ff9d00;font-weight:700">/</span>kingpin.v2&nbsp;v2.2.6<br />go<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;downloading&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>pkg<span style="color:#ff9d00;font-weight:700">/</span>errors&nbsp;v0.8.0<br />go<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;downloading&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>mattn<span style="color:#ff9d00;font-weight:700">/</span>go-colorable&nbsp;v0.0.9<br />go<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;downloading&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>mattn<span style="color:#ff9d00;font-weight:700">/</span>go-isatty&nbsp;v0.0.6<br />go<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;downloading&nbsp;golang.org<span style="color:#ff9d00;font-weight:700">/</span>x<span style="color:#ff9d00;font-weight:700">/</span>sys&nbsp;v0.0.0-20190310054646-10058d7d4faa<br />go<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;downloading&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>alecthomas<span style="color:#ff9d00;font-weight:700">/</span>units&nbsp;v0.0.0-20151022065526-2efee857e7cf<br />go<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;downloading&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>alecthomas<span style="color:#ff9d00;font-weight:700">/</span>template&nbsp;v0.0.0-20160405071501-a0175ee3bccc<br />[root@centos7&nbsp;~]#&nbsp;go&nbsp;get&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>brancz<span style="color:#ff9d00;font-weight:700">/</span>gojsontoyaml<br /><br />[root@centos7&nbsp;~]#&nbsp;<span style="color:#ff9d00;font-weight:700">cp</span>&nbsp;go<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>jb&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span><br />[root@centos7&nbsp;~]#&nbsp;<span style="color:#ff9d00;font-weight:700">cp</span>&nbsp;go<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>gojsontoyaml&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span><br /></div></div><br /><br /><br /><h4>克隆kube-prometheus库</h4><br /><br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">mkdir</span>&nbsp;kube-prometheus<span style="color:#ff9d00;font-weight:700">;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">cd</span>&nbsp;kube-prometheus<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;jb&nbsp;init<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;ll<br />总用量&nbsp;4<br />-rw<span style="color:#ffdd00;font-weight:400">-r</span>--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;66&nbsp;7月&nbsp;&nbsp;12&nbsp;16<span style="color:#ff9d00;font-weight:700">:</span>43&nbsp;jsonnetfile.json<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;jb&nbsp;<span style="color:#ff9d00;font-weight:700">install</span>&nbsp;github.com<span style="color:#ff9d00;font-weight:700">/</span>prometheus-operator<span style="color:#ff9d00;font-weight:700">/</span>kube-prometheus<span style="color:#ff9d00;font-weight:700">/</span>jsonnet<span style="color:#ff9d00;font-weight:700">/</span>kube-prometheus@release-0.5<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>prometheus-operator<span style="color:#ff9d00;font-weight:700">/</span>kube-prometheus<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>b5fbe81d9acab3cf30d3840f1e73b2aad8d6d5ef.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>kubernetes<span style="color:#ff9d00;font-weight:700">/</span>kube-state-metrics<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>e72315512a38653b19dcfe4429f93eadedc0ea96.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>prometheus<span style="color:#ff9d00;font-weight:700">/</span>prometheus<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>cd12f0873c3eb2031f7ba9b2e169449aa1012e3f.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>coreos<span style="color:#ff9d00;font-weight:700">/</span>prometheus-operator<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>beaa1a519e21c8230bab86a15c04bf7e0a9267c1.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>coreos<span style="color:#ff9d00;font-weight:700">/</span>etcd<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>41061e56ad9d654fea2ee02c851d2a74e0a8a593.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>ksonnet<span style="color:#ff9d00;font-weight:700">/</span>ksonnet-lib<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>0d2f82676817bbf9e4acf6495b2090205f323b9f.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-monitoring<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-mixin<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>fe9c4458915fc27c3320918e1a25af91911ea3e2.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>kubernetes<span style="color:#ff9d00;font-weight:700">/</span>kube-state-metrics<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>e72315512a38653b19dcfe4429f93eadedc0ea96.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>prometheus<span style="color:#ff9d00;font-weight:700">/</span>node_exporter<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>fa4edd700ebc1b3614bcd953c215d3f2ab2e0b35.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>brancz<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-grafana<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>57b4365eacda291b82e0d55ba7eec573a8198dda.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>grafana<span style="color:#ff9d00;font-weight:700">/</span>grafonnet-lib<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>3082bfca110166cd69533fa3c0875fdb1b68c329.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>grafana<span style="color:#ff9d00;font-weight:700">/</span>jsonnet-libs<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>e273b9e0cdbac924c9b840780304b3f101aaffe4.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-monitoring<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-mixin<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>a54540b92fb7b2d0826c0eff741e0894943babc7.tar.gz&nbsp;200<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;ll<br />总用量&nbsp;8<br />-rw<span style="color:#ffdd00;font-weight:400">-r</span>--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;&nbsp;294&nbsp;7月&nbsp;&nbsp;12&nbsp;16<span style="color:#ff9d00;font-weight:700">:</span>45&nbsp;jsonnetfile.json<br />-rw<span style="color:#ffdd00;font-weight:400">-r</span>--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;4037&nbsp;7月&nbsp;&nbsp;12&nbsp;16<span style="color:#ff9d00;font-weight:700">:</span>45&nbsp;jsonnetfile.lock.json<br />drwxr-xr<span style="color:#ffdd00;font-weight:400">-x</span>&nbsp;3&nbsp;root&nbsp;root&nbsp;&nbsp;301&nbsp;7月&nbsp;&nbsp;12&nbsp;16<span style="color:#ff9d00;font-weight:700">:</span>45&nbsp;vendor<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;jb&nbsp;update<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>prometheus-operator<span style="color:#ff9d00;font-weight:700">/</span>kube-prometheus<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>b5fbe81d9acab3cf30d3840f1e73b2aad8d6d5ef.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>coreos<span style="color:#ff9d00;font-weight:700">/</span>etcd<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>41061e56ad9d654fea2ee02c851d2a74e0a8a593.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>coreos<span style="color:#ff9d00;font-weight:700">/</span>prometheus-operator<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>beaa1a519e21c8230bab86a15c04bf7e0a9267c1.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>ksonnet<span style="color:#ff9d00;font-weight:700">/</span>ksonnet-lib<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>0d2f82676817bbf9e4acf6495b2090205f323b9f.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>kubernetes<span style="color:#ff9d00;font-weight:700">/</span>kube-state-metrics<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>e72315512a38653b19dcfe4429f93eadedc0ea96.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>prometheus<span style="color:#ff9d00;font-weight:700">/</span>node_exporter<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>fa4edd700ebc1b3614bcd953c215d3f2ab2e0b35.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>brancz<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-grafana<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>57b4365eacda291b82e0d55ba7eec573a8198dda.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-monitoring<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-mixin<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>fe9c4458915fc27c3320918e1a25af91911ea3e2.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>kubernetes<span style="color:#ff9d00;font-weight:700">/</span>kube-state-metrics<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>e72315512a38653b19dcfe4429f93eadedc0ea96.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>prometheus<span style="color:#ff9d00;font-weight:700">/</span>prometheus<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>cd12f0873c3eb2031f7ba9b2e169449aa1012e3f.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>grafana<span style="color:#ff9d00;font-weight:700">/</span>jsonnet-libs<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>e273b9e0cdbac924c9b840780304b3f101aaffe4.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-monitoring<span style="color:#ff9d00;font-weight:700">/</span>kubernetes-mixin<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>a54540b92fb7b2d0826c0eff741e0894943babc7.tar.gz&nbsp;200<br />GET&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>grafana<span style="color:#ff9d00;font-weight:700">/</span>grafonnet-lib<span style="color:#ff9d00;font-weight:700">/</span>archive<span style="color:#ff9d00;font-weight:700">/</span>3082bfca110166cd69533fa3c0875fdb1b68c329.tar.gz&nbsp;200<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">wget</span>&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>raw.githubusercontent.com<span style="color:#ff9d00;font-weight:700">/</span>prometheus-operator<span style="color:#ff9d00;font-weight:700">/</span>kube-prometheus<span style="color:#ff9d00;font-weight:700">/</span>release-0.5<span style="color:#ff9d00;font-weight:700">/</span>build.sh<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">wget</span>&nbsp;https<span style="color:#ff9d00;font-weight:700">://</span>raw.githubusercontent.com<span style="color:#ff9d00;font-weight:700">/</span>prometheus-operator<span style="color:#ff9d00;font-weight:700">/</span>kube-prometheus<span style="color:#ff9d00;font-weight:700">/</span>release-0.5<span style="color:#ff9d00;font-weight:700">/</span>example.jsonnet<br /></div></div><br /><br /><br />example.jsonnet是定制的起点，我们先复制这个文件到你自己命名的项目文件，比如我们是zhangsan.jsonnet，然后用jsonnet执行。(法外狂徒zhangsan 狗头.jpg)<br /><br />然后开始跑下我们的项目<br /><div class="codebox"><div class="codebox">[root@centos7 kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">cp</span>&nbsp;example.jsonnet&nbsp;zhangsan.jsonnet<br />[root@centos7 kube-prometheus]#&nbsp;.<span style="color:#ff9d00;font-weight:700">/</span>build.sh&nbsp;zhangsan.jsonnet</div></div><br /><br /><br />看下脚本内容<br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;build.sh&nbsp;<br /><span style="color:#0088ff;font-weight:400">#!/usr/bin/env&nbsp;bash</span><br /><br /><span style="color:#0088ff;font-weight:400">#&nbsp;This&nbsp;script&nbsp;uses&nbsp;arg&nbsp;$1&nbsp;(name&nbsp;of&nbsp;*.jsonnet&nbsp;file&nbsp;to&nbsp;use)&nbsp;to&nbsp;generate&nbsp;the&nbsp;manifests/*.yaml&nbsp;files.</span><br /><br /><span style="color:#ff9d00;font-weight:700">set</span>&nbsp;-e<br /><span style="color:#ff9d00;font-weight:700">set</span>&nbsp;-x<br /><span style="color:#0088ff;font-weight:400">#&nbsp;only&nbsp;exit&nbsp;with&nbsp;zero&nbsp;if&nbsp;all&nbsp;commands&nbsp;of&nbsp;the&nbsp;pipeline&nbsp;exit&nbsp;successfully</span><br /><span style="color:#ff9d00;font-weight:700">set</span>&nbsp;-o&nbsp;pipefail<br /><br /><span style="color:#0088ff;font-weight:400">#&nbsp;Make&nbsp;sure&nbsp;to&nbsp;use&nbsp;project&nbsp;tooling</span><br /><span style="color:#7f0044;font-weight:400">PATH</span>=<span style="color:#3ad900;font-weight:400">&quot;$(pwd)/tmp/bin:${PATH}&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400">#&nbsp;Make&nbsp;sure&nbsp;to&nbsp;start&nbsp;with&nbsp;a&nbsp;clean&nbsp;&#39;manifests&#39;&nbsp;dir</span><br /><span style="color:#ff9d00;font-weight:700">rm</span>&nbsp;-rf&nbsp;manifests<br /><span style="color:#ff9d00;font-weight:700">mkdir</span>&nbsp;-p&nbsp;manifests<span style="color:#ff9d00;font-weight:700">/</span>setup<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;optional,&nbsp;but&nbsp;we&nbsp;would&nbsp;like&nbsp;to&nbsp;generate&nbsp;yaml,&nbsp;not&nbsp;json</span><br />jsonnet&nbsp;-J&nbsp;vendor&nbsp;-m&nbsp;manifests&nbsp;<span style="color:#3ad900;font-weight:400">&quot;${1-example.jsonnet}&quot;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;<span style="color:#ff9d00;font-weight:700">xargs</span>&nbsp;-I<span style="color:#ff9d00;font-weight:700">{}</span>&nbsp;<span style="color:#ff9d00;font-weight:700">sh</span>&nbsp;-c&nbsp;<span style="color:#3ad900;font-weight:400">&#39;cat&nbsp;{}&nbsp;|&nbsp;gojsontoyaml&nbsp;&gt;&nbsp;{}.yaml;&nbsp;rm&nbsp;-f&nbsp;{}&#39;</span>&nbsp;--&nbsp;<span style="color:#ff9d00;font-weight:700">{}</span><br /></div></div><br /><br /><br /><br /><h3>解释下</h3><br />set -e<br />set命令的-e参数，linux自带的说明如下：<br />&quot;Exit immediately if a simple command exits with a non-zero status.&quot;<br />也就是说，在&quot;set -e&quot;之后出现的代码，一旦出现了返回值非零，整个脚本就会立即退出。有的人喜欢使用这个参数，是出于保证代码安全性的考虑。但有的时候，这种美好的初衷，也会导致严重的问题。<br /><br /><br />set -o pipefail<br />对于set命令-o参数的pipefail选项，linux是这样解释的：<br />&quot;If set, the return value of a pipeline is the value of the last (rightmost) command to exit with a  non-zero  status,or zero if all commands in the pipeline exit successfully.  This option is disabled by default.&quot;<br /><br />设置了这个选项以后，包含管道命令的语句的返回值，会变成最后一个返回非零的管道命令的返回值。听起来比较绕，其实也很简单：<br /><br /># test.sh<br />set -o pipefail<br />ls ./a.txt |echo &quot;hi&quot; &gt;/dev/null<br />echo $?<br /><br />运行test.sh，因为当前目录并不存在a.txt文件，输出：<br />ls: ./a.txt: No such file or directory<br />1  # 设置了set -o pipefail，返回从右往左第一个非零返回值，即ls的返回值1<br /><br />注释掉set -o pipefail 这一行，再次运行，输出：<br />ls: ./a.txt: No such file or directory<br />0  # 没有set -o pipefail，默认返回最后一个管道命令的返回值<br /><br />set -x <br />用于脚本调试。命令执行过程打印到屏幕<br />set -x 是开启 set -x是关闭<br /><br />PATH=<span style="color:#3ad900;">&quot;$(pwd)/tmp/bin:${PATH}&quot;</span><br />设置当前目录的/tmp/bin为环境变量<br /><br /> jsonnet -J vendor -m manifests <span style="color:#3ad900;">&quot;${1-example.jsonnet}&quot;</span> <strong><span style="color:#ff9d00;">|</span></strong> <strong><span style="color:#ff9d00;">xargs</span></strong> -I<strong><span style="color:#ff9d00;">{}</span></strong> <strong><span style="color:#ff9d00;">sh</span></strong> -c <span style="color:#3ad900;">&#39;cat {} | gojsontoyaml &gt; {}.yaml; rm -f {}&#39;</span> -- <strong><span style="color:#ff9d00;">{}</span></strong><br /><br />• -J指定库文件的位置，这里只扫描vendor/文件夹里的内容。 前面我们也提到了， jb update会把所有库文件都保存在vendor下。<br />• -m用到了jsonnet的一个特性，它会把生成的json的最顶层键名作为文件名，值作为内容，写入多个文件，并把文件名输出到标准输出。 目标文件夹是manifests/<br />• &quot;${1-example.jsonnet}&quot;bash的特性，如果没有传入$1，则把example.jsonnet作为输入。<br />• xargs这一段从pipe读取jsonnet输出的文件名，逐个用gojsontoyaml转格式，并写入加了.yaml后缀的文件。<br /><br /><br />然后再看 <br />再看example.jsonnet的内容(以release-05为例)：<br /><br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;zhangsan.jsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">local</span>&nbsp;kp&nbsp;=<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;kube-prometheus/kube-prometheus.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>&nbsp;+<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">//</span>&nbsp;Uncomment&nbsp;the&nbsp;following&nbsp;imports&nbsp;to&nbsp;<span style="color:#ff9d00;font-weight:700">enable</span>&nbsp;its&nbsp;patches<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">//</span>&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;kube-prometheus/kube-prometheus-anti-affinity.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>&nbsp;+<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">//</span>&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;kube-prometheus/kube-prometheus-managed-cluster.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>&nbsp;+<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">//</span>&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;kube-prometheus/kube-prometheus-node-ports.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>&nbsp;+<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">//</span>&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;kube-prometheus/kube-prometheus-static-etcd.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>&nbsp;+<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">//</span>&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;kube-prometheus/kube-prometheus-thanos-sidecar.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>&nbsp;+<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;_config+<span style="color:#ff9d00;font-weight:700">::</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;namespace<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;monitoring&#39;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>,<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">};</span><br /><br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;setup/0namespace-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.kubePrometheus[name]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.kubePrometheus<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;+<br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;setup/prometheus-operator-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.prometheusOperator[name]<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.filter<span style="color:#ff9d00;font-weight:700">((function(</span>name<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;name&nbsp;<span style="color:#ff9d00;font-weight:700">!</span>=&nbsp;<span style="color:#3ad900;font-weight:400">&#39;serviceMonitor&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>,&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.prometheusOperator<span style="color:#ff9d00;font-weight:700">))</span><br /><span style="color:#ff9d00;font-weight:700">}</span>&nbsp;+<br /><span style="color:#ff9d00;font-weight:700">//</span>&nbsp;serviceMonitor&nbsp;is&nbsp;separated&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;be&nbsp;created&nbsp;after&nbsp;the&nbsp;CRDs&nbsp;are&nbsp;ready<br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;prometheus-operator-serviceMonitor&#39;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.prometheusOperator.serviceMonitor&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;+<br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;node-exporter-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.nodeExporter[name]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.nodeExporter<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;+<br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;kube-state-metrics-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.kubeStateMetrics[name]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.kubeStateMetrics<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;+<br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;alertmanager-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.alertmanager[name]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.alertmanager<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;+<br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;prometheus-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.prometheus[name]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.prometheus<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;+<br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;prometheus-adapter-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.prometheusAdapter[name]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.prometheusAdapter<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;+<br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;grafana-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.grafana[name]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.grafana<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span></div></div><br /><br />整个文件其实分两个部分：<br />L1就是第一行的意思<br />1. L1-14定义了变量kp， 你可以不断用+去添加和覆盖。<br />2. L2的(import xxx.libsonnet)就是简单地把libsonet的内容替换到这个位置。<br />3. L10-14实际是一个替换操作。代码里约定俗成，所有用到namspace的地方，都会从$_config.namespace获取。 这里利用+和&quot;late bound&quot;，等同于替换了所有引用namespace的地方。 另外，我们注意到L11中的_config+::用的是双引号，代表_config这个对象，不会出现在最后json的结果中。<br />4. L16-28控制实际的输出。以L23为例，上面提到build.sh会用最顶层的键名作为文件名，这行输出的文件名是[&#39;node-exporter-&#39; + name]， 其中name是通过 std.objectFields()这个标准函数，循环读取某个键下元素名，这个例子里是kp.nodeExporter代表kp变量中nodeExporter下的元素。<br /><br /><br />有个要点，各个库习惯把可配置的变量写在{_config:: {&lt;组件名&gt;: { ... } } }， 定制的时候用+直接修改。那么如何知道哪些变量可以设置呢？一种方法是读项目里提供的例子，另一种就是读库的源码。 另外，对某些设置，可能库并没有提供_config下的变量， 一般来说，这是库作者不推荐修改的，但是你仍旧可以利用jsonnet的特性去做，通常更复杂些。<br /><br />如何开始定制？<br /><br />针对已有组件的配置修改<br />在动手之前，推荐先阅读所有的例子，如果恰巧有匹配的，就照例子修改，主要是对变量kp的修改。这些例子包括：<br />• README.md里Customization Example<br />• example/下的文件<br />• jsonnet/kube-prometheus/下的所有libsonnet<br />• 项目&quot;issue&quot;和&quot;discussion&quot;<br /><br /><br />监控其他通用系统<br />如果是基于已有组件的配置修改，大部分在例子里都能找到。 但如果是要添加新的监控对象，比如kafka，则需要做这些工作：<br />◇ 选择exporter： 用于获取目标的metrics。 参考Prometheus的官网，一些常用系统的exporter。<br />◇ 定制dashboard： 可以从grafana的社区中找模板，自己修改。<br />◇ 编写jsonnet生成相关的配置。 包括exporter的deployment， 设计serviceMonitor，设计告警规则，把dashboard加入grafana。<br /><br /><br />监控自有应用<br />自有应用需要自己编写全部内容。<br />◇ 开发exporter： 开发一个接口。这里可以重用k8s的liveness和readness，让它输出Prometheus的metrics的格式。 这样，在监控目标健康状况的同时，收集metrics。<br />◇ 创建dashboard： 自己用PromQL设计指标，在grafana中用设计呈现，再把设计好的dashboard导出成json供整合用。<br />◇ 编写jsonnet生成相关的配置。<br /><br /><br />测试环境和生产环境<br />最后提一下环境的切换。 从测试的角度，配置修改都需要在测试环境运行通过后，再应用到生产环境中。 这两个环境不完全相同，比如域名，告警邮件地址，告警的钉钉群等等。 如何能方便的切换生成这两个环境的配置？分享一下我的经验：<br />◇ 创建两个文件，比如zhangsan-env-lab.json和zhangsan-env-production.json，把各环境不同变量分别定义在里面，比如<br /><br />{<br />    &quot;domain&quot;: &quot;.example.xxxx.cn&quot;,<br />    &quot;email&quot;: &quot;example@xxxx.com&quot;,<br />    &quot;ding&quot;: &quot;000000000000000000000000000000000000000000000000000000&quot;<br />}<br /><br />◇ 修改build.sh中执行jsonnet那行，增加--ext-str env=&quot;production&quot;，即从命令行传入变量，这是jsonnet的功能。<br />◇ 在zhangsan.jsonnet中根据env判断要引入的哪个json文件，这样后续就可以通过$._config.zhangsanbox.变量名，引用json里的值了。<br /><br />local kp =<br />  ...<br />  {<br />    _config+:: {<br />    ...<br />      zhangsanbox: <br />      // read env type<br />      local env = std.extVar(&quot;env&quot;);<br /><br />      // loading envs from external json<br />      if env == &#39;production&#39; then <br />        (import &#39;zhangsan-env-production.json&#39;)<br />      else <br />        (import &#39;zhangsan-env-lab.json&#39;),<br />      ...<br /><br />◇ 复制build.sh到一个新的文件比如build-test.sh，修改成--ext-str env=&quot;lab&quot;<br />◇ 这样执行./build.sh zhangsan.jsonnet和./build-test.sh zhangsan.jsonnet会对应生产和测试环境的配置。<br /><br /><br /><br /></div>
</body>
</html>
