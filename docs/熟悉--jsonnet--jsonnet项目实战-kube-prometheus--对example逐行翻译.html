<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>对example逐行翻译</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>对example逐行翻译</h1><br/>上篇文章已经搞明白了 kube-prometheus如何自定义 <br /> 但是自定义的详细步骤只能自己尝试，根据项目的作者介绍<a href="https://github.com/prometheus-operator/kube-prometheus#customizing-kube-prometheus">https://github.com/prometheus-operator/kube-prometheus#customizing-kube-prometheus</a><br /> 然后对example.jsonnet逐行继续翻译了解，进行对项目进行梳理<br /> <br /> <br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">cp</span>&nbsp;example.jsonnet&nbsp;zhangsan.jsonnet<br /><span style="color:#ff9d00;font-weight:700">//</span>删除无用的注释，然后保留最上方定义变量，保留一行代码<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;zhangsan.jsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">local</span>&nbsp;kp&nbsp;=<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;kube-prometheus/kube-prometheus.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>&nbsp;+<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;_config+<span style="color:#ff9d00;font-weight:700">::</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;namespace<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;monitoring&#39;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>,<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">};</span><br /><br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;setup/0namespace-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.kubePrometheus[name]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.kubePrometheus<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span><br /><span style="color:#ff9d00;font-weight:700">//</span>&nbsp;&nbsp;&nbsp;setup<span style="color:#ff9d00;font-weight:700">/</span>0namespace-+获取kp.kubePrometheus的key值，获取kp.kubePrometheus的value&nbsp;<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">mkdir</span>&nbsp;-p&nbsp;Greyfus<span style="color:#ff9d00;font-weight:700">/</span>setup<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;jsonnet&nbsp;-J&nbsp;vendor&nbsp;zhangsan.jsonnet&nbsp;-m&nbsp;Greyfus<br />Greyfus<span style="color:#ff9d00;font-weight:700">/</span>setup<span style="color:#ff9d00;font-weight:700">/</span>0namespace-namespace<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;Greyfus<span style="color:#ff9d00;font-weight:700">/</span>setup<span style="color:#ff9d00;font-weight:700">/</span>0namespace-namespace&nbsp;<br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;apiVersion&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;v1&quot;</span>,<br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;kind&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;Namespace&quot;</span>,<br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;metadata&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;name&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;monitoring&quot;</span><br />&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span><br /><span style="color:#ff9d00;font-weight:700">}</span></div></div><br /><br /> 其中我们对+::的用法表示不解,那么我就自己做一个跑一下什么意思<br /> <br /> <br /><div class="codebox"><div class="codebox">&nbsp;[root@centos7&nbsp;jsonnet_learn]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;test.jsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">{</span>a<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#3ad900;font-weight:400">&quot;b&quot;</span>+<br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;_config+<span style="color:#ff9d00;font-weight:700">::</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;namespace<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;monitoring&#39;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>,<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span><br /><br /><span style="color:#ff9d00;font-weight:700">}</span><br />[root@centos7&nbsp;jsonnet_learn]#&nbsp;jsonnet&nbsp;test.jsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;a&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;b{&nbsp;}&quot;</span><br /><span style="color:#ff9d00;font-weight:700">}</span></div></div><br /><br />发现+::最后并不会出现json中<br /><br />修改config<br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;zhangsan.jsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">local</span>&nbsp;kp&nbsp;=<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;kube-prometheus/kube-prometheus.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>&nbsp;+<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;_config+<span style="color:#ff9d00;font-weight:700">::</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;namespace<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;lovemonitoring&#39;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>,<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">};</span><br /><br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;[<span style="color:#3ad900;font-weight:400">&#39;setup/0namespace-&#39;</span>&nbsp;+&nbsp;name]<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kp.kubePrometheus[name]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;<span style="color:#7f0044;font-weight:400">name</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;std.objectFields<span style="color:#ff9d00;font-weight:700">(</span>kp.kubePrometheus<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;jsonnet&nbsp;-J&nbsp;vendor&nbsp;zhangsan.jsonnet&nbsp;-m&nbsp;Greyfus<br />Greyfus<span style="color:#ff9d00;font-weight:700">/</span>setup<span style="color:#ff9d00;font-weight:700">/</span>0namespace-namespace<br />[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;Greyfus<span style="color:#ff9d00;font-weight:700">/</span>setup<span style="color:#ff9d00;font-weight:700">/</span>0namespace-namespace&nbsp;<br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;apiVersion&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;v1&quot;</span>,<br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;kind&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;Namespace&quot;</span>,<br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;metadata&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;name&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;lovemonitoring&quot;</span><br />&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span><br /><span style="color:#ff9d00;font-weight:700">}</span></div></div><br /><br />为什么修改了 _config 数值会变？因为在代码里面，有$_config.namespce的调用，代表获取最外层定义的_config对象的值。<br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;kube-prometheus]#&nbsp;<span style="color:#ff9d00;font-weight:700">sed</span>&nbsp;-n&nbsp;<span style="color:#3ad900;font-weight:400">&#39;19p&#39;</span>&nbsp;vendor<span style="color:#ff9d00;font-weight:700">/</span>kube-prometheus<span style="color:#ff9d00;font-weight:700">/</span>kube-prometheus.libsonnet&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;namespace<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;k.core.v1.namespace.new<span style="color:#ff9d00;font-weight:700">(</span>$._config.namespace<span style="color:#ff9d00;font-weight:700">)</span>,</div></div><br />这个要怎么去理解呢？<br /><br />因为$代表了最外层的{} 一个local变量整个可以看成一个大{}，然后就可以用$.去调用后定义的对象<br /><br />举例说明，因为jsonnet有下面这种特性<br /><br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;jsonnet_learn]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;test2.jsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">{</span>&nbsp;a<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;c&#39;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;+&nbsp;<span style="color:#ff9d00;font-weight:700">{</span>&nbsp;c<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;d&#39;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span><br />[root@centos7&nbsp;jsonnet_learn]#&nbsp;jsonnet&nbsp;test2.jsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;a&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;c&quot;</span>,<br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;c&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;d&quot;</span><br /><span style="color:#ff9d00;font-weight:700">}</span></div></div><br /><br /><br /><br />我们定义一个json，来举例这种_config的用法<br /><br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;jsonnet_learn]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;test.jsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">local</span>&nbsp;martinis&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;my.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>&nbsp;+<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">{</span>&nbsp;mad+<span style="color:#ff9d00;font-weight:700">::</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;madc<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;love&#39;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;<span style="color:#ff9d00;font-weight:700">}</span><br /><span style="color:#ff9d00;font-weight:700">//</span>主文件引用my.libsonnet，输出引用martinis，因为这里的mad是隐式的<br /><span style="color:#ff9d00;font-weight:700">//</span>引用文件需要把他显式调用出来<br /><span style="color:#ff9d00;font-weight:700">;</span><br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;_config+<span style="color:#ff9d00;font-weight:700">::</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;namespaces<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;lovemonitoring&#39;</span>,<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>,<br />&nbsp;&nbsp;a<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;$._config.namespaces,<br />&nbsp;&nbsp;b<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;$._config,<br />&nbsp;&nbsp;c<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;martinis,<br />&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">//</span>这里输出<br /><span style="color:#ff9d00;font-weight:700">}</span><br /><br />[root@centos7&nbsp;jsonnet_learn]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;my.libsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">local</span>&nbsp;kpl&nbsp;=&nbsp;import&nbsp;<span style="color:#3ad900;font-weight:400">&#39;myok.libsonnet&#39;</span><span style="color:#ff9d00;font-weight:700">;</span><br /><br />kpl+<br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;cccc+<span style="color:#ff9d00;font-weight:700">::</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;c&#39;</span>,<br />&nbsp;&nbsp;bbbbb<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;d&#39;</span>,<br />&nbsp;&nbsp;ooo<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;kpl.k,<br /><span style="color:#ff9d00;font-weight:700">}</span><br /><span style="color:#ff9d00;font-weight:700">//</span>my.libsonnet引用myok.libsonnet，那么这两个引用的值是他们的集合<br />[root@centos7&nbsp;jsonnet_learn]#&nbsp;<span style="color:#ff9d00;font-weight:700">cat</span>&nbsp;myok.libsonnet&nbsp;<br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;k<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&#39;ccc&#39;</span>,<br />&nbsp;&nbsp;l<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;$.mad,<br /><span style="color:#ff9d00;font-weight:700">}</span><br /><span style="color:#ff9d00;font-weight:700">//</span>这里myok.libsonnet引用最外层的mad值<span style="color:#ff9d00;font-weight:700">(</span>$.mad<span style="color:#ff9d00;font-weight:700">)</span>，这里是显式的调用</div></div><br /><br />运行代码，发现引入的 mad值已经生效<br /><div class="codebox"><div class="codebox">[root@centos7&nbsp;jsonnet_learn]#&nbsp;jsonnet&nbsp;test.jsonnet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br /><span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;a&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;lovemonitoring&quot;</span>,<br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;b&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;namespaces&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;lovemonitoring&quot;</span><br />&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>,<br />&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;c&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;bbbbb&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;d&quot;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;k&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;ccc&quot;</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;l&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;madc&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;love&quot;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">&quot;ooo&quot;</span><span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#3ad900;font-weight:400">&quot;ccc&quot;</span><br />&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">}</span><br /><span style="color:#ff9d00;font-weight:700">}</span></div></div></div>
</body>
</html>
